<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>ARea WebXR Viewer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <script src="https://ga.jspm.io/npm:es-module-shims@1.10.0/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>

<div id="err"></div>

<!-- Startscreen wie beim WebXR-Viewer, inkl. Girlande -->
<div id="start-screen">
  <div id="start-content">
    <div id="start-card">
      <div id="ar-experience-label">AR EXPERIENCE</div>
      <h1 id="start-title"></h1>
      <p id="start-subline"></p>
      <img id="start-image" style="display:none;" alt="Vorschau"/>
      <p id="start-text"></p>
      <button class="btn-start" id="btn-enter-ar">STARTE AR‚ú®</button>
    </div>
    <img id="tannengruen-frame" src="./assets/Tannengruen.png" alt="Dekorativer Tannengr√ºn-Rahmen" aria-hidden="true"/>
  </div>
</div>

<!-- Kamerabild (wird als Texture in Three genutzt) -->
<video id="camera-video" playsinline autoplay muted></video>

<!-- Overlay-UI -->
<div id="overlay">
  <div class="ui-row">
    <button class="btn-icon" id="btn-close" aria-label="AR-Session beenden">√ó</button>
    <button class="btn-icon" id="btn-mute" style="display:none" aria-label="Audio umschalten">üîä</button>
  </div>

  <!-- Galerie-Overlay -->
  <div id="gallery-panel" aria-hidden="true">
    <div id="gallery-inner">
      <header id="gallery-header">
        <span>Aufnahmen</span>
        <button id="gallery-close" type="button" aria-label="Galerie schlie√üen">‚úï</button>
      </header>

      <div id="gallery-body">
        <section id="gallery-preview">
          <div id="gallery-preview-media"></div>
          <div id="gallery-meta">
            <div id="gallery-filename"></div>
            <button id="gallery-download" type="button">
              Download / Teilen
            </button>
          </div>
        </section>

        <section id="gallery-grid"></section>
      </div>
    </div>
  </div>

  <!-- Aufnahme + Galerie -->
  <div id="ar-capture-controls">
    <!-- EIN Haupt-Button: kurz = Foto, lang = Video -->
    <button id="btn-main-capture" class="btn-capture" type="button"
            aria-label="Foto (tippen) oder Video (halten)">
      <svg id="progress-ring" viewBox="0 0 80 80" width="80" height="80">
        <circle id="progress-circle" cx="40" cy="40" r="34"></circle>
      </svg>
      <span id="capture-icon">üì∏</span>
    </button>

    <button id="btn-screenshot" class="btn-capture btn-screenshot" type="button"
            aria-label="Screenshot aufnehmen">
      üì∑
    </button>

    <!-- Kleiner Galerie-Button -->
    <button id="btn-gallery-small" class="btn-capture btn-gallery" type="button"
            aria-label="Aufnahmen anzeigen">
      üñºÔ∏è
    </button>
  </div>

  <div id="msg-container">
    <div id="msg" role="status" aria-live="polite">Tippe auf die Zielmarkierung, um das Modell zu platzieren.</div>
  </div>

  <div id="gesture-layer"></div>
</div>

<audio id="ar-audio" loop playsinline preload="auto" crossorigin="anonymous"></audio>

<script type="module">
import * as THREE from 'three';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
// Lokale DeviceOrientationControls (statt unpkg)
import { DeviceOrientationControls } from './js/DeviceOrientationControls.js';

// ---------------------------------------------------------
// Globale Variablen (Three.js / AR-State)
// ---------------------------------------------------------
let camera, scene, renderer;
let controls;
let placementGroup;
let placementRect;
let model;
let mixer;
const clock = new THREE.Clock();

let isModelPlaced = false;
let modelLoaded = false;
let isEditing = false;
let isHovering = false;

let currentTouches = [];
let gestureStartTime = 0;
let tapStartX = 0;
let tapStartY = 0;
let didMove = false;
let isDraggingModel = false;
let isRotatingModel = false;
let isScalingModel = false;

const ROTATION_FACTOR = 0.018;
const SCALE_FACTOR = 0.005;
const DRAG_THRESHOLD_PIX = 18;
const TAP_THRESHOLD_MS = 350;
const RECT_SIZE = 0.5;

let initialPinchDistance = 0;
let initialModelScale = 1;
let lastMoveX = 0;

const raycaster = new THREE.Raycaster();
const ndc = new THREE.Vector2();
const floorPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);

// Szene / Worker-URLs
const qs = new URLSearchParams(location.search);
const workerBase = (qs.get('base') || 'https://area-publish-proxy.area-webar.workers.dev').replace(/\/$/, '');
const sceneParam = qs.get('scene') || qs.get('src');
let SCENE_JSON_URL = '';
let MODEL_URL = '';
let AUDIO_URL = '';

// Audio
const audioEl = document.getElementById('ar-audio');
const btnMute = document.getElementById('btn-mute');
let isMuted = false;
let audioCtx = null;

// ---------------------------------------------------------
// Audio-Helfer
// ---------------------------------------------------------
function ensureAudioUnlocked() {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume().catch(() => {});
    }
  } catch (e) {
    console.warn('AudioContext konnte nicht initialisiert werden:', e);
  }
}

async function tryStartAudioIfPossible() {
  if (!AUDIO_URL || isMuted) return;
  try {
    ensureAudioUnlocked();
    if (audioEl.paused) await audioEl.play();
  } catch (_) {}
}

function setupAudio(audioCfg) {
  btnMute.style.display = 'flex';
  btnMute.textContent = 'üîä';
  btnMute.setAttribute('aria-label', 'Audio ausschalten');
  audioEl.crossOrigin = 'anonymous';
  audioEl.src = AUDIO_URL;
  audioEl.loop = !!audioCfg.loop;

  const sceneVolume =
    (audioCfg && typeof audioCfg.volume === 'number')
      ? audioCfg.volume
      : 0.8;

  const masterVolume = 0.3;
  audioEl.volume = sceneVolume * masterVolume;

  btnMute.onclick = () => {
    isMuted = !isMuted;
    audioEl.muted = isMuted;
    btnMute.textContent = isMuted ? 'üîá' : 'üîä';
    btnMute.setAttribute('aria-label', isMuted ? 'Audio einschalten' : 'Audio ausschalten');
    if (!isMuted) {
      tryStartAudioIfPossible();
    }
  };
}

// ---------------------------------------------------------
// Scene-Config laden und Startscreen bef√ºllen
// ---------------------------------------------------------
async function loadSceneConfig(sceneId, baseUrl) {
  const url = `${baseUrl}/scenes/${encodeURIComponent(sceneId)}/scene.json`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Konfiguration nicht ladbar (${res.status})`);
  return await res.json();
}

function applyWelcomeToStartScreen(cfg, sceneId, baseUrl) {
  const meta    = cfg.meta || {};
  const welcome = (cfg.ui && cfg.ui.welcome) || {};

  const titleEl   = document.getElementById('start-title');
  const sublineEl = document.getElementById('start-subline');
  const textEl    = document.getElementById('start-text');
  const imgEl     = document.getElementById('start-image');

  if (titleEl)   titleEl.textContent   = meta.title       || welcome.title   || '';
  if (sublineEl) sublineEl.textContent = meta.subtitle    || welcome.eyebrow || '';
  if (textEl)    textEl.textContent    = meta.description || welcome.desc    || '';

  const posterFile = meta.posterImage || welcome.poster;
  if (imgEl && posterFile) {
    imgEl.src = `${baseUrl}/scenes/${encodeURIComponent(sceneId)}/${encodeURIComponent(posterFile)}`;
    imgEl.style.display = 'block';
  } else if (imgEl) {
    imgEl.style.display = 'none';
  }
}

// ---------------------------------------------------------
// Three.js Setup (Kamera, Szene, Renderer etc.)
// ---------------------------------------------------------
function initThree() {
  const video = document.getElementById('camera-video');
  if (!video) {
    throw new Error('camera-video Element fehlt.');
  }

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(
    60,
    window.innerWidth / window.innerHeight,
    0.01,
    100
  );
  scene.add(camera);

  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
  hemiLight.position.set(0, 1, 0);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
  dirLight.position.set(1, 2, 1);
  scene.add(dirLight);

  renderer = new THREE.WebGLRenderer({
    antialias: true,
    alpha: true
  });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight, false);
  renderer.setClearColor(0x000000, 0);

  document.body.appendChild(renderer.domElement);

  // DeviceOrientationControls
  controls = new DeviceOrientationControls(camera);

  window.addEventListener('resize', onWindowResize);
}

async function initCameraStream() {
  const video = document.getElementById('camera-video');
  if (!video) return;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment'
      },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
  } catch (e) {
    console.error('Kamera konnte nicht gestartet werden:', e);
    showErr('Kamera konnte nicht gestartet werden: ' + (e.message || e));
  }
}

function onWindowResize() {
  if (!camera || !renderer) return;
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight, false);
}

// ---------------------------------------------------------
// Modell laden
// ---------------------------------------------------------
async function loadModel(modelUrl, audioCfg) {
  const loadingMsg = document.getElementById('msg');
  if (loadingMsg) loadingMsg.textContent = 'Lade Modell ‚Ä¶';

  const loader = new GLTFLoader();
  const draco = new DRACOLoader();
  draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
  loader.setDRACOLoader(draco);

  const gltf = await loader.loadAsync(modelUrl);
  model = gltf.scene;
  if (!model) throw new Error('GLB enth√§lt keine Scene.');

  model.visible = false;
  scene.add(model);

  if (gltf.animations && gltf.animations.length > 0) {
    mixer = new THREE.AnimationMixer(model);
    const clip = gltf.animations[0];
    const action = mixer.clipAction(clip);
    action.play();
  }

  modelLoaded = true;
  if (loadingMsg) loadingMsg.textContent = 'Tippe auf die Zielmarkierung, um das Modell zu platzieren.';

  if (audioCfg) {
    setupAudio(audioCfg);
  }
}

// ---------------------------------------------------------
// Render-Loop
// ---------------------------------------------------------
let _animId = null;

function startRenderLoop() {
  if (_animId) return;

  const renderLoop = () => {
    _animId = requestAnimationFrame(renderLoop);

    const delta = clock.getDelta();
    if (controls) controls.update();
    if (mixer) mixer.update(delta);

    renderer.render(scene, camera);
  };

  renderLoop();
}

function stopRenderLoop() {
  if (_animId) {
    cancelAnimationFrame(_animId);
    _animId = null;
  }
}

// ---------------------------------------------------------
// Fehlermeldung
// ---------------------------------------------------------
function showErr(msg) {
  const el = document.getElementById('err');
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
}

// ---------------------------------------------------------
// Reset zur√ºck zum Startscreen
// ---------------------------------------------------------
function resetARState() {
  const startScreen = document.getElementById('start-screen');
  const overlay = document.getElementById('overlay');
  const btnEnterAR = document.getElementById('btn-enter-ar');

  stopRenderLoop();

  // Kamera stoppen
  const video = document.getElementById('camera-video');
  if (video && video.srcObject) {
    const tracks = video.srcObject.getTracks();
    tracks.forEach(t => t.stop());
    video.srcObject = null;
  }

  audioEl.pause();

  if (startScreen) startScreen.style.display = 'flex';
  if (overlay) {
    overlay.style.pointerEvents = 'none';
    overlay.style.opacity = 0;
  }

  isModelPlaced = false;
  isEditing = false;

  if (btnEnterAR) btnEnterAR.disabled = !modelLoaded;

  const msg = document.getElementById('msg');
  if (msg) msg.textContent = 'Tippe auf die Zielmarkierung, um das Modell zu platzieren.';
}

// ---------------------------------------------------------
// DOMContentLoaded ‚Äì Haupt-Init
// ---------------------------------------------------------
document.addEventListener('DOMContentLoaded', async () => {
  const startScreen = document.getElementById('start-screen');
  const overlay     = document.getElementById('overlay');
  const btnEnterAR  = document.getElementById('btn-enter-ar');
  const btnClose    = document.getElementById('btn-close');

  // Initial: Startscreen sichtbar, Overlay blocken
  if (startScreen) startScreen.style.display = 'flex';
  if (overlay) {
    overlay.style.pointerEvents = 'none';
    overlay.style.opacity = 0;
  }
  if (btnEnterAR) btnEnterAR.disabled = true;

  if (!sceneParam) {
    showErr('FEHLENDE URL PARAMETER (scene)');
    return;
  }

  try {
    // 1. Three + Kamera
    initThree();
    await initCameraStream();

    // 2. Scene-Config
    const cfg = await loadSceneConfig(sceneParam, workerBase);
    console.log('[WebXR] SceneConfig:', cfg);

    // URLs setzen
    MODEL_URL = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/${encodeURIComponent(cfg.model.url)}`;
    if (cfg.audio && cfg.audio.url) {
      AUDIO_URL = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/${encodeURIComponent(cfg.audio.url)}`;
    }

    // Startscreen bef√ºllen
    applyWelcomeToStartScreen(cfg, sceneParam, workerBase);

    // 3. Modell + Audio laden
    await loadModel(MODEL_URL, cfg.audio || null);

    if (btnEnterAR) btnEnterAR.disabled = false;

  } catch (e) {
    console.error('[WebXR] Init-Fehler:', e);
    showErr('FEHLER: ' + (e.message || e));
    return;
  }

  // STARTE AR Button
  if (btnEnterAR) {
    btnEnterAR.addEventListener('click', async () => {
      btnEnterAR.disabled = true;
      try {
        if (startScreen) startScreen.style.display = 'none';
        if (overlay) {
          overlay.style.pointerEvents = 'auto';
          overlay.style.opacity = 1;
        }

        await tryStartAudioIfPossible();
        startRenderLoop();
      } catch (e) {
        console.error('AR Start fehlgeschlagen:', e);
        showErr('AR konnte nicht gestartet werden: ' + (e.message || e));
        btnEnterAR.disabled = false;
      }
    });
  }

  // Close-Button ‚Üí zur√ºck zum Startscreen
  if (btnClose) {
    btnClose.addEventListener('click', () => {
      resetARState();
    });
  }
});
</script>

</body>
</html>
