<script type="module">
/* ... bestehender Code ... */

// In setupAudio: nach src setzen direkt load() starten
function setupAudio(audioCfg) {
  btnMute.style.display = 'flex';
  btnMute.textContent = 'üîä';

  audioEl.crossOrigin = 'anonymous';
  audioEl.src = AUDIO_URL;
  audioEl.loop = !!audioCfg.loop;
  audioEl.volume = audioCfg.volume ?? 0.8;

  // WICHTIG: direkt laden, damit readyState beim Klick eher >= 2 ist
  try {
    audioEl.load();
  } catch (e) {}

  const markReady = () => { audioReady = true; };
  audioEl.addEventListener('canplay', markReady, { once: true });
  audioEl.addEventListener('canplaythrough', markReady, { once: true });

  audioEl.addEventListener('error', (e) => {
    console.error('Audio load error:', e);
  });

  // Direktes Play im sichtbaren Button-Click (Geste-Kontext)
  btnMute.onclick = () => {
    isMuted = !isMuted;
    audioEl.muted = isMuted;
    btnMute.textContent = isMuted ? 'üîá' : 'üîä';
    if (!isMuted) {
      ensureAudioUnlocked();
      // Direkter Versuch im selben Click-Stack
      audioEl.play().then(() => {
        updateMsg('');
      }).catch(() => {
        // Fallback auf robusten Start
        tryStartAudio();
      });
    } else {
      audioEl.pause();
    }
  };
}

// In onStartAR Klick-Verkettung: direkter Play-Versuch VOR async-Operationen
async function onStartAR() {
  document.getElementById('start-screen').style.display = 'none';

  // SOFORT, synchron, ohne await, im selben Geste-Kontext versuchen
  if (AUDIO_URL && !isMuted) {
    ensureAudioUnlocked();
    audioEl.play().catch(() => {
      // Wenn abgelehnt, fallback auf robusten Loader/Starter
      tryStartAudio();
    });
  }

  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['hit-test', 'local-floor'],
    optionalFeatures: ['dom-overlay'],
    domOverlay: { root: document.getElementById('overlay') }
  });

  session.addEventListener('end', async () => {
    hitTestSourceRequested = false;
    hitTestSource = null;
    renderer.setAnimationLoop(null);
    await renderer.xr.setSession(null);
    
    document.getElementById('start-screen').style.display = 'flex';
    audioEl.pause();
    havePose = false;
    isPlaced = false;
    hasBeenMoved = false; 
    placementGroup.visible = false;
    updateMsg("Bewege dein Ger√§t um Fl√§che zu finden...");
  });

  renderer.xr.setReferenceSpaceType('local-floor');
  await renderer.xr.setSession(session);

  renderer.setAnimationLoop(render);
}

/* ... restlicher Code ... */
</script>
