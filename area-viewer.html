<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>ARea Native AR Viewer</title>

  <!-- Fonts & Styles (dein bestehendes styles.css mit Startscreen & Tannengrün) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <!-- model-viewer (für Native AR: Scene Viewer / Quick Look) -->
  <script type="module"
          src="https://unpkg.com/@google/model-viewer@4.1.0/dist/model-viewer.min.js">
  </script>

  <style>
    /* model-viewer vollständig unsichtbar halten – wir nutzen nur die AR-Funktion */
    #native-ar-model {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      visibility: hidden;
      pointer-events: none;
      background: #000;
    }

    /* Fehlermeldungen oben – wie gehabt */
    #err {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      z-index: 2000;
      display: none;
    }
  </style>
</head>
<body>

<div id="err"></div>

<!-- Dein bestehender Startscreen mit Tannengrün-Rahmen -->
<div id="start-screen">
  <div id="start-content">
    <div id="start-card">
      <div id="ar-experience-label">AR EXPERIENCE</div>
      <h1 id="start-title"></h1>
      <p id="start-subline"></p>
      <img id="start-image" style="display:none;" alt="Vorschau"/>
      <p id="start-text"></p>
      <button class="btn-start" id="btn-enter-ar">STARTE AR✨</button>
    </div>
    <img id="tannengruen-frame" src="./assets/Tannengruen.png"
         alt="Dekorativer Tannengrün-Rahmen" aria-hidden="true"/>
  </div>
</div>

<!-- Verstecktes model-viewer – nur als „Brücke“ zum nativen Viewer -->
<model-viewer id="native-ar-model"
              ar
              ar-modes="scene-viewer quick-look"
              ar-scale="fixed"
              ar-placement="floor"
              camera-controls="false"
              autoplay
              shadow-intensity="1"
              exposure="1">
</model-viewer>

<!-- Audio, das parallel zur AR-Szene spielt -->
<audio id="ar-audio" loop preload="auto" crossorigin="anonymous"></audio>

<script type="module">
  const qs = new URLSearchParams(location.search);
  const workerBase = (qs.get('base') || 'https://area-publish-proxy.area-webar.workers.dev').replace(/\/$/, '');
  const sceneParam = qs.get('scene') || qs.get('src');

  let SCENE_JSON_URL = '';
  let MODEL_URL = '';
  let IOS_URL = '';
  let AUDIO_URL = '';

  const startScreen  = document.getElementById('start-screen');
  const btnEnterAR   = document.getElementById('btn-enter-ar');
  const startTitle   = document.getElementById('start-title');
  const startSubline = document.getElementById('start-subline');
  const startText    = document.getElementById('start-text');
  const startImage   = document.getElementById('start-image');

  const mv      = document.getElementById('native-ar-model');
  const audioEl = document.getElementById('ar-audio');
  let isAudioReady = false;

  function showErr(msg) {
    const box = document.getElementById('err');
    box.textContent = msg;
    box.style.display = 'block';
    clearTimeout(box._timer);
    box._timer = setTimeout(() => box.style.display = 'none', 5000);
  }

  function setStartTexts({title, subline, body, posterUrl}) {
    startTitle.innerHTML   = title || '';
    startSubline.innerHTML = subline || '';
    startText.innerHTML    = body || '';

    if (posterUrl) {
      startImage.src = posterUrl;
      startImage.style.display = 'block';
      startImage.alt = title ? `${title} Vorschau` : 'Vorschau';
    } else {
      startImage.style.display = 'none';
    }
  }

  async function loadSceneConfigIfNeeded() {
    if (!sceneParam) {
      // Fallback-Dummy
      MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      setStartTexts({
        title: 'Demo Astronaut',
        subline: 'Beispielszene',
        body: 'Kein Szene-Parameter – Demo-Modell wird angezeigt.'
      });
      return;
    }

    if (sceneParam.endsWith('.glb') || sceneParam.endsWith('.gltf')) {
      MODEL_URL = sceneParam;
      return;
    }

    SCENE_JSON_URL = `${workerBase}/scenes/${sceneParam}/scene.json`;

    try {
      const res = await fetch(SCENE_JSON_URL);
      if (!res.ok) {
        throw new Error(`Scene JSON Error: ${res.status} ${res.statusText}`);
      }
      const json = await res.json();

      const meta    = json.meta || {};
      const welcome = (json.ui && json.ui.welcome) || {};

      const title =
        (meta.title && meta.title.trim()) ||
        (welcome.title && welcome.title.trim()) || '';

      const subline =
        (meta.subtitle && meta.subtitle.trim()) ||
        (welcome.eyebrow && welcome.eyebrow.trim()) || '';

      const body =
        (meta.body && meta.body.trim()) ||
        (meta.description && meta.description.trim()) ||
        (welcome.desc && welcome.desc.trim()) || '';

      const posterFile =
        (meta.posterImage && String(meta.posterImage).trim()) ||
        (welcome.poster && String(welcome.poster).trim()) || '';

      const posterUrl = posterFile
        ? `${workerBase}/scenes/${sceneParam}/${encodeURIComponent(posterFile)}`
        : '';

      setStartTexts({ title, subline, body, posterUrl });

      if (json.model?.url) {
        MODEL_URL = `${workerBase}/scenes/${sceneParam}/${json.model.url}`;
      } else {
        MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
        showErr('Hinweis: Szene-JSON enthält keine Modell-URL. Fallback-Modell wird verwendet.');
      }

      // Optional: eigener iOS-Quick-Look-URL aus der Szene
      if (json.model?.iosUrl) {
        IOS_URL = `${workerBase}/scenes/${sceneParam}/${json.model.iosUrl}`;
      }

      if (json.audio?.url) {
        AUDIO_URL = `${workerBase}/scenes/${sceneParam}/${json.audio.url}`;
      }
    } catch (err) {
      console.error(err);
      showErr('Fehler beim Laden der Szene-Konfiguration: ' + err.message);
    }
  }

  function configureModelViewer() {
    if (!MODEL_URL) return;

    mv.src = MODEL_URL;

    if (IOS_URL) {
      mv.setAttribute('ios-src', IOS_URL);
    } else {
      mv.removeAttribute('ios-src');
    }

    // Immer Bodenplatzierung – „schwebt“ minimieren
    mv.setAttribute('ar-placement', 'floor');
    mv.setAttribute('ar-scale', 'fixed');
    mv.setAttribute('shadow-intensity', '1');
    mv.setAttribute('reveal', 'manual'); // wir zeigen das 3D-Canvas nie
  }

  function prepareAudio() {
    if (!AUDIO_URL) {
      isAudioReady = false;
      return;
    }
    audioEl.src = AUDIO_URL;
    audioEl.loop = true;
    isAudioReady = true;
  }

  async function startAudioIfPossible() {
    if (!isAudioReady) return;
    try {
      await audioEl.play();
    } catch (err) {
      console.warn('Audio konnte nicht automatisch gestartet werden:', err);
      showErr('Audio konnte nicht automatisch gestartet werden (Autoplay-Block).');
    }
  }

  async function boot() {
    btnEnterAR.disabled = true;

    await loadSceneConfigIfNeeded();
    configureModelViewer();
    prepareAudio();

    // Sobald model-viewer geladen hat, kannst du AR starten
    mv.addEventListener('load', () => {
      btnEnterAR.disabled = false;
    });

    mv.addEventListener('error', (ev) => {
      console.error('model-viewer Fehler', ev);
      showErr('Fehler beim Laden des 3D-Modells.');
    });

    btnEnterAR.addEventListener('click', async () => {
      if (!MODEL_URL) {
        showErr('Kein 3D-Modell konfiguriert.');
        return;
      }

      // Willkommensscreen weg
      startScreen.style.display = 'none';

      // Audio im gleichen User-Gesture starten
      await startAudioIfPossible();

      // Direkt AR starten (Scene Viewer / Quick Look)
      try {
        await mv.activateAR();
        // Wenn der Nutzer AR wieder schließt, kehrt er auf diese Seite zurück
        // Audio kannst du dann optional stoppen:
        audioEl.pause();
      } catch (err) {
        console.error('activateAR() fehlgeschlagen', err);
        showErr('AR konnte nicht gestartet werden: ' + (err.message || 'Unbekannter Fehler'));

        // Fallback: Startscreen wieder anzeigen
        startScreen.style.display = 'flex';
      }
    });
  }

  boot();
</script>

</body>
</html>
