<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ARea Native AR Viewer</title>

  <!-- Fonts & Styles wie im WebXR-Viewer -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <!-- Model-Viewer: nur native AR (Scene Viewer / Quick Look) -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@3.5.0/dist/model-viewer.min.js"></script>
</head>
<body>

<div id="err"></div>

<!-- Welcome-Screen mit Tannengrün-Ranke -->
<div id="start-screen">
  <div id="start-content">
    <div id="start-card">
      <div id="ar-experience-label">AR EXPERIENCE</div>
      <h1 id="start-title"></h1>
      <p id="start-subline"></p>
      <img id="start-image" style="display:none;" alt="Vorschau"/>
      <p id="start-text"></p>
      <button class="btn-start" id="btn-enter-ar">STARTE AR✨</button>
    </div>
    <img id="tannengruen-frame"
         src="./assets/Tannengruen.png"
         alt="Dekorativer Tannengrün-Rahmen"
         aria-hidden="true"/>
  </div>
</div>

<!-- Versteckter Model-Viewer: triggert nur native AR -->
<model-viewer
  id="area-native-viewer"
  style="width:1px;height:1px;opacity:0;position:absolute;pointer-events:none;"
  ar
  ar-modes="scene-viewer quick-look"
  camera-controls
  autoplay
  shadow-intensity="1"
  exposure="1"
  environment-image="neutral">
</model-viewer>

<script type="module">
  const errEl = document.getElementById('err');
  function showErr(msg) {
    console.error('[ARea Native Viewer]', msg);
    if (!errEl) return;
    errEl.textContent = msg;
    errEl.style.display = 'block';
    setTimeout(() => { errEl.style.display = 'none'; }, 7000);
  }

  // URL-Parameter: ?scene=...&base=...
  const qs = new URLSearchParams(location.search);
  const workerBase = (qs.get('base') || 'https://area-publish-proxy.area-webar.workers.dev').replace(/\/$/, '');
  const sceneParam = qs.get('scene') || qs.get('src') || '';

  let SCENE_JSON_URL = '';
  let MODEL_URL = '';
  let IOS_URL = '';
  let POSTER_URL = '';
  let AUDIO_URL = ''; // aktuell nur informativ, kein eigenes UI

  const mv           = document.getElementById('area-native-viewer');
  const btnEnterAR   = document.getElementById('btn-enter-ar');
  const startScreen  = document.getElementById('start-screen');
  const startImage   = document.getElementById('start-image');
  const startTitle   = document.getElementById('start-title');
  const startSubline = document.getElementById('start-subline');
  const startText    = document.getElementById('start-text');

  async function loadSceneConfig() {
    // 1) Direkte GLB-URL via ?scene=...glb oder ?src=...
    if (sceneParam && sceneParam.endsWith('.glb')) {
      MODEL_URL = sceneParam;
      return;
    }

    // 2) Kein Parameter -> Demo
    if (!sceneParam) {
      MODEL_URL  = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      POSTER_URL = 'https://modelviewer.dev/assets/poster-astronaut.png';

      startTitle.textContent   = 'Demo-Szene';
      startSubline.textContent = 'ARea Native Viewer';
      startText.textContent    = 'Kein „scene“-Parameter gefunden – Demo-Modell wird geladen.';
      return;
    }

    // 3) ARea-Szene aus Worker
    SCENE_JSON_URL = `${workerBase}/scenes/${sceneParam}/scene.json`;

    const res = await fetch(SCENE_JSON_URL, { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Scene JSON Error: ${res.status} ${res.statusText}`);
    }
    const json = await res.json();

    const meta    = json.meta || {};
    const welcome = (json.ui && json.ui.welcome) || {};

    const title =
      (meta.title && meta.title.trim()) ||
      (welcome.title && welcome.title.trim()) ||
      '';
    const subline =
      (meta.subtitle && meta.subtitle.trim()) ||
      (welcome.eyebrow && welcome.eyebrow.trim()) ||
      '';
    const body =
      (meta.body && meta.body.trim()) ||
      (meta.description && meta.description.trim()) ||
      (welcome.desc && welcome.desc.trim()) ||
      '';

    const posterFile =
      (meta.posterImage && String(meta.posterImage).trim()) ||
      (welcome.poster && String(welcome.poster).trim()) ||
      '';

    startTitle.innerHTML   = title;
    startSubline.innerHTML = subline;
    startText.innerHTML    = body;

    if (posterFile) {
      POSTER_URL = `${workerBase}/scenes/${sceneParam}/${encodeURIComponent(posterFile)}`;
      startImage.src = POSTER_URL;
      startImage.style.display = 'block';
      startImage.alt = title ? `${title} Vorschau` : 'Vorschau';
    } else {
      startImage.style.display = 'none';
    }

    // Modell (GLB)
    if (json.model?.url) {
      MODEL_URL = `${workerBase}/scenes/${sceneParam}/${json.model.url}`;
    } else if (json.model?.src) {
      MODEL_URL = `${workerBase}/scenes/${sceneParam}/${json.model.src}`;
    } else {
      MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      showErr('Hinweis: Szene-JSON enthält keine Modell-URL. Fallback-Modell wird verwendet.');
    }

    // iOS USDZ
    if (json.model?.iosUrl || json.model?.iosSrc) {
      const iosFile = json.model.iosUrl || json.model.iosSrc;
      IOS_URL = `${workerBase}/scenes/${sceneParam}/${iosFile}`;
    }

    // Audio (derzeit noch kein eigenes UI)
    if (json.audio?.url) {
      AUDIO_URL = `${workerBase}/scenes/${sceneParam}/${json.audio.url}`;
    }
  }

  function setupModelViewer() {
    if (!mv) return;

    if (MODEL_URL) {
      mv.src = MODEL_URL;
    }
    if (IOS_URL) {
      mv.setAttribute('ios-src', IOS_URL);
    }
    if (POSTER_URL) {
      mv.setAttribute('poster', POSTER_URL);
    }

    // Animationen im GLB automatisch laufen lassen
    mv.setAttribute('reveal', 'auto');
    // autoplay ist bereits als Boolean-Attribut im Markup gesetzt
  }

  async function boot() {
    btnEnterAR.disabled = true;
    startScreen.style.display = 'flex';

    try {
      await loadSceneConfig();
    } catch (err) {
      showErr('Fehler beim Laden der Szene-Konfiguration: ' + (err.message || err));
    }

    setupModelViewer();
    btnEnterAR.disabled = false;
  }

  // Klick auf "STARTE AR✨" -> direkt native AR, kein WebXR, kein Zwischenschritt
  btnEnterAR.addEventListener('click', async () => {
    if (!mv) return;

    btnEnterAR.disabled = true;
    try {
      await mv.activateAR();
      // Bei Erfolg übernimmt Scene Viewer / Quick Look – nach Rückkehr bleibt
      // der Button disabled (optional könnte man hier wieder aktivieren).
    } catch (err) {
      showErr('AR konnte nicht gestartet werden: ' + (err.message || err));
      btnEnterAR.disabled = false;
    }
  });

  boot();
</script>

</body>
</html>
