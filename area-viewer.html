<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>ARea Native AR Viewer</title>

  <!-- Fonts & Styles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css"/>

  <!-- model-viewer (als nativer AR-Launcher) -->
  <script type="module"
          src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js">
  </script>

  <!-- Basis-Meta (dynamisches OG per JS klappt für WhatsApp nicht, das wäre Worker-Thema) -->
  <meta name="description" content="ARea AR Experience – native AR-Ansicht auf deinem Smartphone.">
</head>
<body>

<div id="err"></div>

<!-- Startscreen wie beim WebXR-Viewer, inkl. Girlande -->
<div id="start-screen">
  <div id="start-content">
    <div id="start-card">
      <div id="ar-experience-label">AR EXPERIENCE</div>
      <h1 id="start-title"></h1>
      <p id="start-subline"></p>
      <img id="start-image" style="display:none;" alt="Vorschau"/>
      <p id="start-text"></p>
      <button class="btn-start" id="btn-enter-ar" disabled>STARTE AR✨</button>
    </div>
    <img id="tannengruen-frame"
         src="./assets/Tannengruen.png"
         alt="Dekorativer Tannengrün-Rahmen"
         aria-hidden="true"/>
  </div>
</div>

<!-- Einfache Statuszeile (optional) -->
<div id="msg-container">
  <div id="msg" role="status" aria-live="polite">
    Lade Szene…
  </div>
</div>

<!-- Unsichtbarer model-viewer als nativer AR-Launcher -->
<model-viewer id="native-ar-viewer"
              src=""
              ios-src=""
              ar
              ar-modes="scene-viewer quick-look webxr"
              camera-controls
              autoplay
              style="
                position: fixed;
                width: 1px;
                height: 1px;
                top: -9999px;
                left: -9999px;
                opacity: 0;
                pointer-events: none;
              ">
</model-viewer>

<!-- Optionales Audio (läuft parallel über die Seite, Lautstärke per Gerätetasten) -->
<audio id="ar-audio" loop preload="auto" crossorigin="anonymous"></audio>

<script type="module">
  // --- Kleine Helfer ---
  function showErr(txt) {
    const e = document.getElementById('err');
    e.textContent = txt;
    e.style.display = 'block';
    setTimeout(() => { e.style.display = 'none'; }, 7000);
  }

  function updateMsg(txt) {
    const m = document.getElementById('msg');
    if (m) m.textContent = txt;
  }

  // --- URL-Parameter / Szene-Setup ---
  const qs = new URLSearchParams(location.search);
  const DEFAULT_WORKER_BASE = 'https://area-publish-proxy.area-webar.workers.dev';
  const workerBase = (qs.get('base') || DEFAULT_WORKER_BASE).replace(/\/$/, '');
  const sceneParam = qs.get('scene') || qs.get('src') || '';

  let SCENE_JSON_URL = '';
  let MODEL_URL = '';
  let IOS_URL = '';
  let AUDIO_URL = '';

  if (sceneParam) {
    if (sceneParam.endsWith('.glb') || sceneParam.endsWith('.gltf') || sceneParam.startsWith('http')) {
      // Direkter Modell-Link
      MODEL_URL = sceneParam;
    } else if (sceneParam.endsWith('.usdz')) {
      IOS_URL = sceneParam;
    } else {
      // Standard-Fall: Scene-ID → scene.json beim Worker
      SCENE_JSON_URL = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/scene.json`;
    }
  }

  const audioEl = document.getElementById('ar-audio');

  async function boot() {
    const startScreen = document.getElementById('start-screen');
    const btnEnterAR = document.getElementById('btn-enter-ar');
    const startImage = document.getElementById('start-image');
    const startTitle = document.getElementById('start-title');
    const startSubline = document.getElementById('start-subline');
    const startText = document.getElementById('start-text');
    const mv = document.getElementById('native-ar-viewer');

    startScreen.style.display = 'flex';
    btnEnterAR.disabled = true;
    updateMsg('Lade Szene…');

    // Defaults
    startTitle.textContent = '';
    startSubline.textContent = '';
    startText.textContent = '';
    startImage.style.display = 'none';

    // Szene aus JSON laden (falls vorhanden)
    if (SCENE_JSON_URL) {
      try {
        const res = await fetch(SCENE_JSON_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`Scene JSON Error: ${res.status} ${res.statusText}`);
        const json = await res.json();

        const meta    = json.meta || {};
        const welcome = (json.ui && json.ui.welcome) || {};
        const model   = json.model || {};
        const audio   = json.audio || {};

        const title =
          (meta.title && meta.title.trim()) ||
          (welcome.title && welcome.title.trim()) ||
          '';

        const subline =
          (meta.subtitle && meta.subtitle.trim()) ||
          (welcome.eyebrow && welcome.eyebrow.trim()) ||
          '';

        const body =
          (meta.body && meta.body.trim()) ||
          (meta.description && meta.description.trim()) ||
          (welcome.desc && welcome.desc.trim()) ||
          '';

        const posterFile =
          (meta.posterImage && String(meta.posterImage).trim()) ||
          (welcome.poster && String(welcome.poster).trim()) ||
          '';

        // Welcome-Screen befüllen
        if (title)   startTitle.innerHTML   = title;
        if (subline) startSubline.innerHTML = subline;
        if (body)    startText.innerHTML    = body;

        if (posterFile) {
          const imageUrl = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/${encodeURIComponent(posterFile)}`;
          startImage.src = imageUrl;
          startImage.alt = title ? `${title} Vorschau` : 'Vorschau';
          startImage.style.display = 'block';
        }

        // Modell-URLs
        if (model.url) {
          MODEL_URL = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/${model.url}`;
        }
        if (model.iosUrl) {
          IOS_URL = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/${model.iosUrl}`;
        }

        // Audio-URL (läuft parallel über Seite)
        if (audio.url) {
          AUDIO_URL = `${workerBase}/scenes/${encodeURIComponent(sceneParam)}/${audio.url}`;
          audioEl.src = AUDIO_URL;
          try { audioEl.load(); } catch (_) {}
        }

      } catch (e) {
        console.error(e);
        showErr('Fehler beim Laden der Szene-Konfiguration: ' + e.message);
      }
    }

    // Fallback, falls kein Modell gesetzt
    if (!MODEL_URL) {
      MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      showErr('Hinweis: Szene enthält keine Modell-URL. Fallback-Modell wird verwendet.');
    }

    // model-viewer konfigurieren
    mv.src = MODEL_URL;
    if (IOS_URL) {
      mv.setAttribute('ios-src', IOS_URL);
    } else {
      mv.removeAttribute('ios-src');
    }

    // AR-Button im model-viewer selbst verstecken (Safety)
    const style = document.createElement('style');
    style.textContent = `
      model-viewer::part(default-ar-button) {
        display: none !important;
      }
    `;
    document.head.appendChild(style);

    btnEnterAR.disabled = false;
    updateMsg('Tippe auf „Starte AR“, um die AR-Szene zu öffnen.');

    // Klick-Handler: direkt AR starten
    btnEnterAR.addEventListener('click', async () => {
      // Startscreen kann weg, während AR läuft
      startScreen.style.display = 'none';
      updateMsg('Starte AR…');

      // Audio versuchen zu starten (läuft parallel, Lautstärke per Gerätetasten)
      if (AUDIO_URL) {
        try { await audioEl.play(); } catch (_) { /* Ignorieren, falls blockiert */ }
      }

      try {
        if (typeof mv.activateAR === 'function') {
          const r = mv.activateAR();
          // r kann ein Promise sein – Fehler in catch
          if (r && typeof r.then === 'function') {
            await r.catch(err => { throw err; });
          }
        } else {
          throw new Error('activateAR() wird von model-viewer nicht unterstützt.');
        }

        // Nach AR-Ende kehrt der User auf diese Seite zurück.
        // Wir zeigen wieder den Startscreen zum „Nochmal ansehen“.
        window.addEventListener('focus', () => {
          startScreen.style.display = 'flex';
          updateMsg('Tippe erneut auf „Starte AR“, um die Szene noch einmal zu öffnen.');
        }, { once: true });

      } catch (err) {
        console.error('AR konnte nicht gestartet werden:', err);
        showErr('AR konnte nicht gestartet werden. Dein Gerät / Browser unterstützt evtl. keinen nativen AR-Modus.');

        // Fallback: 3D-Modell normal im Browser zeigen
        mv.style.position = 'relative';
        mv.style.width = '100%';
        mv.style.height = '70vh';
        mv.style.top = '0';
        mv.style.left = '0';
        mv.style.opacity = '1';
        mv.style.pointerEvents = 'auto';

        updateMsg('Dein Gerät unterstützt keinen nativen AR-Modus. Du kannst das Modell hier in 3D betrachten.');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', boot);
</script>

</body>
</html>
