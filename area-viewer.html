<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>ARea AR Viewer</title>

  <!-- Platzhalter für Sharing – wirklich dynamisch/statisch lösen wir später im Publish-Step -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="ARea AR Experience">
  <meta property="og:description" content="Interaktive 3D-AR-Szene mit ARea.">
  <meta property="og:image" content="">
  <meta property="og:url" content="">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <!-- <model-viewer> von CDN -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>

<div id="err"></div>

<!-- Welcome-Screen: wie beim WebXR-Viewer -->
<div id="start-screen">
  <div id="start-content">
    <div id="start-card">
      <div id="ar-experience-label">AR EXPERIENCE</div>
      <h1 id="start-title"></h1>
      <p id="start-subline"></p>
      <img id="start-image" style="display:none;" alt="Vorschau"/>
      <p id="start-text"></p>
      <button class="btn-start" id="btn-enter-ar">STARTE AR ✨</button>
    </div>
    <img id="tannengruen-frame" src="./assets/Tannengrün.png" alt="" aria-hidden="true"/>
  </div>
</div>

<!-- Native AR Viewer – KEINE eigene UI darüber! -->
<model-viewer id="area-viewer"
  style="display:none; width:100%; height:100%; background:#000;"
  src=""
  ios-src=""
  alt="ARea AR Szene"
  ar
  ar-modes="scene-viewer quick-look"
  ar-scale="auto"
  ar-placement="floor"
  camera-controls
  touch-action="pan-y"
  shadow-intensity="0.8"
  exposure="1"
  autoplay
  environment-image="neutral">
</model-viewer>

<!-- Optional: Hintergrund-Audio für Inline-Ansicht -->
<audio id="ar-audio" loop preload="auto" crossorigin="anonymous"></audio>

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  const workerBase = (qs.get('base') || 'https://area-publish-proxy.area-webar.workers.dev').replace(/\/$/, '');
  const sceneParam = qs.get('scene') || qs.get('src');

  let SCENE_JSON_URL = '';
  let MODEL_URL = '';
  let USDZ_URL = '';
  let AUDIO_URL = '';
  let POSTER_FILE = '';

  const errEl = document.getElementById('err');
  function showErr(msg) {
    if (!errEl) return;
    errEl.textContent = msg;
    errEl.style.display = 'block';
    setTimeout(() => errEl.style.display = 'none', 6000);
  }

  async function loadSceneConfig() {
    // Fallback: Demo-Astronaut
    if (!sceneParam) {
      MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      USDZ_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.usdz';
      return {
        meta: {
          title: 'ARea AR Demo',
          subtitle: 'Beweg dein Smartphone und starte AR.',
          body: 'Dieses Beispiel zeigt eine einfache AR-Demo mit einem Astronauten.'
        }
      };
    }

    // Direkt-Link (z.B. GLB/USDC) statt sceneId?
    if (
      sceneParam.endsWith('.glb') ||
      sceneParam.endsWith('.gltf') ||
      sceneParam.endsWith('.usdz')
    ) {
      if (sceneParam.endsWith('.usdz')) {
        USDZ_URL = sceneParam;
        // optional: passender GLB-Name, falls du beides ablegst
        MODEL_URL = sceneParam.replace(/\.usdz$/i, '.glb');
      } else {
        MODEL_URL = sceneParam;
      }
      return { meta: {} };
    }

    // Normaler Fall: Szene aus Worker
    SCENE_JSON_URL = `${workerBase}/scenes/${sceneParam}/scene.json`;
    const res = await fetch(SCENE_JSON_URL, { credentials: 'omit' });
    if (!res.ok) {
      throw new Error('Scene JSON Error: ' + res.status + ' ' + res.statusText);
    }
    const json = await res.json();

    const meta    = json.meta || {};
    const welcome = (json.ui && json.ui.welcome) || {};

    const title =
      (meta.title && meta.title.trim()) ||
      (welcome.title && welcome.title.trim()) ||
      '';

    const subtitle =
      (meta.subtitle && meta.subtitle.trim()) ||
      (welcome.eyebrow && welcome.eyebrow.trim()) ||
      '';

    const body =
      (meta.body && meta.body.trim()) ||
      (meta.description && meta.description.trim()) ||
      (welcome.desc && welcome.desc.trim()) ||
      '';

    POSTER_FILE =
      (meta.posterImage && String(meta.posterImage).trim()) ||
      (welcome.poster && String(welcome.poster).trim()) ||
      '';

    if (json.model && json.model.url) {
      MODEL_URL = `${workerBase}/scenes/${sceneParam}/${json.model.url}`;
    } else {
      MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
      showErr('Hinweis: Szene-JSON enthält keine Modell-URL. Fallback-Modell wird verwendet.');
    }

    // iOS / USDZ
    if (json.model && (json.model.usdzUrl || json.model.iosUrl)) {
      const u = json.model.usdzUrl || json.model.iosUrl;
      USDZ_URL = `${workerBase}/scenes/${sceneParam}/${u}`;
    }

    // Audio (nur für Inline möglich – in Quick Look/Scene Viewer hat OS die Kontrolle)
    if (json.audio && json.audio.url) {
      AUDIO_URL = `${workerBase}/scenes/${sceneParam}/${json.audio.url}`;
    }

    return { meta: { title, subtitle, body } };
  }

  function applyMetaToStartScreen(meta) {
    const startTitle   = document.getElementById('start-title');
    const startSubline = document.getElementById('start-subline');
    const startText    = document.getElementById('start-text');
    const startImage   = document.getElementById('start-image');

    if (startTitle)   startTitle.innerHTML   = meta.title    || '';
    if (startSubline) startSubline.innerHTML = meta.subtitle || '';
    if (startText)    startText.innerHTML    = meta.body     || '';

    if (startImage) {
      if (POSTER_FILE && sceneParam) {
        const url = `${workerBase}/scenes/${sceneParam}/${encodeURIComponent(POSTER_FILE)}`;
        startImage.src = url;
        startImage.style.display = 'block';
        startImage.alt = meta.title ? meta.title + ' – Vorschau' : 'AR Vorschau';
      } else {
        startImage.style.display = 'none';
      }
    }

    if (meta.title) {
      document.title = meta.title;
    }
  }

  function configureModelViewer() {
    const mv = document.getElementById('area-viewer');
    if (!mv) return;

    if (MODEL_URL) mv.src = MODEL_URL;
    if (USDZ_URL) mv.setAttribute('ios-src', USDZ_URL);

    if (POSTER_FILE && sceneParam) {
      const posterUrl = `${workerBase}/scenes/${sceneParam}/${encodeURIComponent(POSTER_FILE)}`;
      mv.setAttribute('poster', posterUrl);
    }

    // WICHTIG: Keine eigenen Overlays / Gesture-Layer, damit
    // - Pinch-Zoom & Rotate in 3D-Preview funktionieren
    // - in AR der native UI-Layer (inkl. Screenshot-Button) sichtbar ist
  }

  function setupAudio() {
    if (!AUDIO_URL) return;
    const audioEl = document.getElementById('ar-audio');
    if (!audioEl) return;
    audioEl.src = AUDIO_URL;
    audioEl.loop = true;
    audioEl.volume = 0.6;
  }

  async function boot() {
    const startScreen = document.getElementById('start-screen');
    const btnEnterAR  = document.getElementById('btn-enter-ar');

    if (startScreen) startScreen.style.display = 'flex';
    if (btnEnterAR)  btnEnterAR.disabled = true;

    let sceneMeta = { meta: {} };
    try {
      sceneMeta = await loadSceneConfig();
    } catch (err) {
      console.error(err);
      showErr('Fehler beim Laden der Szene: ' + (err.message || err));
    }

    applyMetaToStartScreen(sceneMeta.meta || {});
    configureModelViewer();
    setupAudio();

    if (btnEnterAR) {
      btnEnterAR.disabled = false;
      btnEnterAR.addEventListener('click', async () => {
        const mv      = document.getElementById('area-viewer');
        const audioEl = document.getElementById('ar-audio');

        if (startScreen) startScreen.style.display = 'none';
        if (mv) mv.style.display = 'block';

        // Audio im Inline-Viewer starten (OS kann es beim Wechsel in die native AR-Ansicht pausieren)
        if (AUDIO_URL && audioEl) {
          try {
            await audioEl.play();
          } catch (e) {
            console.warn('Audio-Start blockiert:', e);
          }
        }
      });
    }
  }

  boot();
})();
</script>

</body>
</html>
