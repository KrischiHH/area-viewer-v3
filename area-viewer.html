<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>ARea Native AR Viewer</title>

  <!-- Fonts + Styles (Bangers + dein Stylesheet mit Tannengrün usw.) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <!-- model-viewer (nur für nativen AR-Start) -->
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
</head>
<body>

<div id="err" style="display:none;"></div>

<!-- 1) Dein Welcome-Screen bleibt wie er ist (inkl. Tannengrün-Rahmen) -->
<div id="start-screen">
  <div id="start-content">
    <div id="start-card">
      <div id="ar-experience-label">AR EXPERIENCE</div>
      <h1 id="start-title"></h1>
      <p id="start-subline"></p>
      <img id="start-image" style="display:none;" alt="Vorschau"/>
      <p id="start-text"></p>
      <button class="btn-start" id="btn-enter-ar">STARTE AR✨</button>
    </div>
    <!-- WICHTIG: Dateiname wie in deinem Projekt (ohne Umlaut) -->
    <img id="tannengruen-frame"
         src="./assets/Tannengruen.png"
         alt="Dekorativer Tannengrün-Rahmen"
         aria-hidden="true"/>
  </div>
</div>

<!-- 2) Versteckter model-viewer: nur zum Öffnen des nativen AR-Viewers -->
<model-viewer id="native-ar"
  style="display:none; width:100%; height:100%; background-color:#000;"
  ar
  ar-modes="scene-viewer quick-look webxr"
  camera-controls
  autoplay
  shadow-intensity="1"
  environment-image="neutral"
  exposure="1"
  xr-environment
>
</model-viewer>

<!-- 3) Audio (ohne eigenes UI) -->
<audio id="ar-audio" loop playsinline preload="auto" crossorigin="anonymous"></audio>

<script type="module">
  // --- Basis-Helfer --------------------------------------------------------
  const errEl = document.getElementById('err');
  function showErr(msg) {
    console.error('[ARea native]', msg);
    errEl.textContent = msg;
    errEl.style.display = 'block';
    setTimeout(() => { errEl.style.display = 'none'; }, 6000);
  }

  // URL-Parameter wie im WebXR-Viewer
  const qs = new URLSearchParams(location.search);
  const workerBase = (qs.get('base') || 'https://area-publish-proxy.area-webar.workers.dev').replace(/\/$/, '');
  const sceneParam = qs.get('scene') || qs.get('src');

  let SCENE_JSON_URL = '';
  let MODEL_URL = '';
  let IOS_URL = '';
  let AUDIO_URL = '';

  // DOM-Referenzen
  const startScreen   = document.getElementById('start-screen');
  const startTitle    = document.getElementById('start-title');
  const startSubline  = document.getElementById('start-subline');
  const startText     = document.getElementById('start-text');
  const startImage    = document.getElementById('start-image');
  const btnEnterAR    = document.getElementById('btn-enter-ar');
  const mv            = document.getElementById('native-ar');
  const audioEl       = document.getElementById('ar-audio');

  let audioCfg = null;
  let audioCtx = null;

  function ensureAudioUnlocked() {
    try {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().catch(() => {});
      }
    } catch (e) {
      console.warn('AudioContext konnte nicht initialisiert werden:', e);
    }
  }

  function setupAudio(cfg) {
    if (!cfg || !AUDIO_URL) return;
    audioCfg = cfg;
    audioEl.crossOrigin = 'anonymous';
    audioEl.src = AUDIO_URL;
    audioEl.loop = !!cfg.loop;

    const sceneVolume =
      (typeof cfg.volume === 'number') ? cfg.volume : 0.8;

    const masterVolume = 0.3;
    audioEl.volume = sceneVolume * masterVolume;

    try { audioEl.load(); } catch (e) {}
  }

  async function tryPlayAudio() {
    if (!AUDIO_URL) return;
    try {
      ensureAudioUnlocked();
      if (audioEl.paused) {
        await audioEl.play();
      }
    } catch (e) {
      console.warn('Audio konnte nicht automatisch gestartet werden:', e);
    }
  }

  // --- Szene-Config laden (wie im WebXR-Viewer) ---------------------------
  async function loadSceneConfig() {
    // Szenen-URL bestimmen
    if (sceneParam) {
      if (sceneParam.endsWith('.glb') || sceneParam.endsWith('.gltf') || sceneParam.endsWith('.usdz')) {
        // direkter Modell-Link
        MODEL_URL = sceneParam;
      } else {
        // Standard: Worker-Szene
        SCENE_JSON_URL = `${workerBase}/scenes/${sceneParam}/scene.json`;
      }
    }

    if (SCENE_JSON_URL) {
      try {
        const res = await fetch(SCENE_JSON_URL);
        if (!res.ok) {
          throw new Error(`Scene JSON Error: ${res.status} ${res.statusText}`);
        }
        const json = await res.json();

        const meta    = json.meta || {};
        const welcome = (json.ui && json.ui.welcome) || {};

        const title =
          (meta.title && meta.title.trim()) ||
          (welcome.title && welcome.title.trim()) ||
          '';

        const subline =
          (meta.subtitle && meta.subtitle.trim()) ||
          (welcome.eyebrow && welcome.eyebrow.trim()) ||
          '';

        const body =
          (meta.body && meta.body.trim()) ||
          (meta.description && meta.description.trim()) ||
          (welcome.desc && welcome.desc.trim()) ||
          '';

        const posterFile =
          (meta.posterImage && String(meta.posterImage).trim()) ||
          (welcome.poster && String(welcome.poster).trim()) ||
          '';

        // Welcome-Texte/Bild setzen
        startTitle.innerHTML   = title;
        startSubline.innerHTML = subline;
        startText.innerHTML    = body;

        if (posterFile) {
          const imageUrl = `${workerBase}/scenes/${sceneParam}/${encodeURIComponent(posterFile)}`;
          startImage.src = imageUrl;
          startImage.style.display = 'block';
          startImage.alt = title ? `${title} Vorschau` : 'Vorschau';
        } else {
          startImage.style.display = 'none';
        }

        // Modell-URLs
        if (json.model?.url) {
          MODEL_URL = `${workerBase}/scenes/${sceneParam}/${json.model.url}`;
        }
        // Optional iOS-/USDZ-Pfad, falls du ihn irgendwann ins JSON einträgst
        if (json.model?.iosUrl || json.model?.ios_src || json.model?.usdz) {
          const iosFile = json.model.iosUrl || json.model.ios_src || json.model.usdz;
          IOS_URL = `${workerBase}/scenes/${sceneParam}/${iosFile}`;
        }

        // Audio
        if (json.audio?.url) {
          AUDIO_URL = `${workerBase}/scenes/${sceneParam}/${json.audio.url}`;
          setupAudio(json.audio);
        }
      } catch (e) {
        console.error(e);
        showErr('Fehler beim Laden der Szene-Konfiguration: ' + e.message);
      }
    }

    // Fallback-Modell, falls nichts gesetzt wurde
    if (!MODEL_URL) {
      MODEL_URL = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
    }
  }

  // --- Native AR starten --------------------------------------------------
  async function startNativeAR() {
    if (!MODEL_URL) {
      showErr('Für diese Szene ist kein 3D-Modell konfiguriert.');
      return;
    }

    // Modell-Quellen in model-viewer setzen
    mv.src = MODEL_URL;
    if (IOS_URL) {
      mv.setAttribute('ios-src', IOS_URL);
    }

    // model-viewer sichtbar machen (wird aber direkt in AR wechseln)
    mv.style.display = 'block';

    // Audio vor AR versuchen
    if (AUDIO_URL) {
      await tryPlayAudio();
    }

    // AR-Fähigkeit prüfen (falls API vorhanden)
    try {
      if (typeof mv.canActivateAR === 'function') {
        const can = await mv.canActivateAR();
        if (!can) {
          showErr('Dein Gerät/Browser unterstützt keinen nativen AR-Viewer. Das Modell wird nur in 3D angezeigt.');
          return;
        }
      }
    } catch (e) {
      // canActivateAR ist optional – nicht schlimm, wenn es fehlt
      console.warn('canActivateAR() nicht verfügbar oder fehlgeschlagen:', e);
    }

    // Versuche zuerst showAR() (neue API), dann activateAR() (ältere)
    let started = false;

    if (typeof mv.showAR === 'function') {
      try {
        await mv.showAR();
        started = true;
      } catch (e) {
        console.warn('showAR() fehlgeschlagen:', e);
      }
    }

    if (!started && typeof mv.activateAR === 'function') {
      try {
        mv.activateAR();
        started = true;
      } catch (e) {
        console.warn('activateAR() fehlgeschlagen:', e);
      }
    }

    if (!started) {
      showErr('AR konnte nicht gestartet werden. Eventuell unterstützt dein Gerät keine nativen AR-Viewer.');
      // Inline-3D bleibt dann als Fallback sichtbar
    }
  }

  // --- Events von model-viewer (optional) ---------------------------------
  mv.addEventListener('ar-status', (event) => {
    const status = event.detail.status;
    // 'session-started' / 'presenting' / 'not-presenting' / 'failed'
    if (status === 'failed') {
      showErr('AR konnte nicht gestartet werden: ' + (event.detail.reason || 'Unbekannter Fehler.'));
    }

    // Wenn der User AR wieder verlässt → Welcome-Screen optional erneut zeigen
    if (status === 'not-presenting') {
      // Wenn du nach AR-Ende wieder den Startscreen zeigen willst:
      startScreen.style.display = 'flex';
      mv.style.display = 'none';
      // Audio stoppen
      try { audioEl.pause(); } catch (_) {}
    }
  });

  // --- Boot ---------------------------------------------------------------
  async function boot() {
    // Welcome-Screen initial sichtbar, Button erstmal deaktivieren
    startScreen.style.display = 'flex';
    btnEnterAR.disabled = true;

    // Texte leeren (bis JSON da ist)
    startTitle.textContent   = '';
    startSubline.textContent = '';
    startText.textContent    = '';
    startImage.style.display = 'none';

    await loadSceneConfig();

    // Jetzt darf gestartet werden
    btnEnterAR.disabled = false;

    // Klick-Handler: direkt nativen AR-Viewer starten
    btnEnterAR.addEventListener('click', async () => {
      btnEnterAR.disabled = true;

      // Welcome-Screen ausblenden
      startScreen.style.display = 'none';

      try {
        await startNativeAR();
      } catch (e) {
        console.error(e);
        showErr('AR konnte nicht gestartet werden: ' + (e.message || e));
        // Falls AR gar nicht geht, zeigst du zumindest das inline-3D
        mv.style.display = 'block';
      } finally {
        // Wenn AR gar nicht startet, Button wieder aktivieren,
        // damit man es nochmal probieren kann.
        btnEnterAR.disabled = false;
      }
    });
  }

  // Starten sobald DOM bereit
  boot().catch((e) => {
    console.error(e);
    showErr('Fehler beim Initialisieren des Viewers: ' + e.message);
  });
</script>

</body>
</html>
